"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,a){function r(o,i){try{var n=t[o](i),s=n.value}catch(e){return void a(e)}if(!n.done)return Promise.resolve(s).then(function(e){r("next",e)},function(e){r("throw",e)});e(s)}return r("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_constant=require("./../utils/constant.js"),_tip=require("./../utils/tip.js"),_tip2=_interopRequireDefault(_tip),_api=require("./../api/api.js"),_api2=_interopRequireDefault(_api),_wxParse=require("./../plugins/wxParse/wxParse.js"),_wxParse2=_interopRequireDefault(_wxParse),_comment_list=require("./../components/comment_list.js"),_comment_list2=_interopRequireDefault(_comment_list),goodsDetail=function(e){function t(){var e,a,r,o;_classCallCheck(this,t);for(var i=arguments.length,n=Array(i),s=0;s<i;s++)n[s]=arguments[s];return a=r=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(n))),r.config={navigationBarTitleText:"商品详情"},r.data={img_domain:_constant.IMG_DOMAIN,winWidth:0,winHeight:"100%",goodsId:0,priceId:"",detail:{},good_bigimg:[],startTime:"",endTime:"",hidden:!0,animationData:"",orderType:1,orderNum:1,isFavorite:!1,isValidDate:!0,canOrder:!0,purchasetype:1,purchaseText:"立即购买",special:0,commentList:[],commentList1:[],commentCount:0},r.$repeat={},r.$props={commentList:{"xmlns:v-bind":"","v-bind:list.sync":"commentList"}},r.$events={},r.components={commentList:_comment_list2.default},r.computed={},r.events={},r.methods={homePage:function(){_wepy2.default.switchTab({url:"/pages/home"})},moreComment:function(){_wepy2.default.navigateTo({url:"/pages/comment?goodsId="+this.goodsId+"&priceId="+this.priceId})},previewImage:function(e){var t=e.target.dataset.src,a=[],r=this.detail.photoList;Object.keys(r).forEach(function(e){a.push(r[e].photo)}),wx.previewImage({current:t,urls:a})},bindOrderNumInput:function(e){this.orderNum=e.detail.value},takeOrder:function(){this.canOrder&&(this.showConfirmData(),this.orderType=2)},takeCart:function(){this.canOrder&&(this.showConfirmData(),this.orderType=1)},takeFavorite:function(){1==this.isFavorite?(this.goodsUnFavorite(),console.log("取消收藏"),console.log(this.isFavorite)):(this.goodsFavorite(),console.log("收藏"))},closeModel:function(){var e=this;this.winHeight="100%",this.animation.height(0).step(),this.setData({animationData:this.animation.export()}),setTimeout(function(){e.hidden=!0,e.$apply()},100)},confirmTake:function(){1==this.orderType?this.doTakeCart():2==this.orderType&&this.doTakeOrder()},jiaBtnTap:function(e){this.orderNum++},jianBtnTap:function(){this.orderNum>1&&this.orderNum--},selAttr:function(e){for(var t=e.currentTarget.dataset.id,a=e.currentTarget.dataset.nameid,r=e.currentTarget.dataset.index,o=0;o<this.detail.goodsSkuNameList.length;o++)for(var i=this.detail.goodsSkuNameList[o].skuValList,n=0;n<i.length;n++){var s=i[n];if(s.skuNameId==a&&(s.current=!1,s.skuValId==t)){s.current=!0,this.detail.goodsSkuValIds[r]=t;for(var u=0;u<this.detail.goodsSkuList.length;u++){JSON.parse(this.detail.goodsSkuList[u].skuValIds).toArray;if(console.log("goodskuids..."+this.detail.goodsSkuList[u].skuValIds),console.log("this goodskuids..."+this.detail.goodsSkuValIds),"["+this.detail.goodsSkuValIds.toString()+"]"===this.detail.goodsSkuList[u].skuValIds){console.log("goodskuids equals..."),this.detail.stockNum=this.detail.goodsSkuList[u].stockNum,this.detail.price=this.detail.goodsSkuList[u].price,this.$apply();break}}}}},onShareAppMessage:function(e){return"button"===e.from&&console.log(e.target),{title:this.detail.name,path:"/pages/goods_detail?id="+this.goodsId,success:function(e){},fail:function(e){}}}},o=a,_possibleConstructorReturn(r,o)}return _inherits(t,e),_createClass(t,[{key:"onLoad",value:function(e){var t=this;this.orderNum=1,this.purchasetype=1,this.isFavorite=!1,this.isValidDate=!0,this.canOrder=!0,this.hidden=!0,this.winHeight="100%",t.detail={},t.$apply();var a=_wepy2.default.getStorageSync(_constant.USER_SPECICAL_INFO)||{},r=_wepy2.default.getStorageSync(_constant.USER_INFO)||{};a.openid&&!((a.expires_in||Date.now())<Date.now()+600)||r.nickName||_wepy2.default.navigateTo({url:"/pages/login"}),t.goodsId=e.id,t.priceId=e.priceId,void 0!=e.purchasetype&&(this.purchasetype=e.purchasetype),2==this.purchasetype?this.purchaseText="申请补货":this.purchaseText="立即购买",void 0!=e.special&&(this.special=e.special),t.getGoodsDetail(),t.addUserBrowser(),t.getGoodsEvaluate(),console.log("special==="+this.special)}},{key:"onShow",value:function(){this.goodsIsFavorite();var e=wx.createAnimation({transformOrigin:"50% 50%",duration:200,timingFunction:"linear",delay:0});this.animation=e}},{key:"wxParseImgLoad",value:function(e){}},{key:"wxParseImgTap",value:function(e){var t=this,a=e.target.dataset.src,r=e.target.dataset.from;void 0!==r&&r.length>0&&wx.previewImage({current:a,urls:t.bindData[r].imageUrls})}},{key:"getGoodsDetail",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,a,r,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this,e.next=3,_api2.default.goodsDetail({query:{gid:t.goodsId,priceId:t.priceId}});case 3:a=e.sent,r={},0==a.data.code?(o=a.data.data,parseInt(o.stockNum)<=0&&(o.stockNum=0),t.detail=o,_wxParse2.default.wxParse("detailInfo","html",t.detail.detailInfo,this),r.endTime=t.detail.validEndTime,r.startTime=t.detail.startTime,"0"==a.data.validDate&&(t.isValidDate=!1,1==this.purchasetype&&1!=this.special&&(this.canOrder=!1))):a.data.msg?_tip2.default.error(a.data.msg):_tip2.default.error("查看商品失败"),t.$apply();case 7:case"end":return e.stop()}},e,this)}));return e}()},{key:"addUserBrowser",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,a,r,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this,a=_wepy2.default.getStorageSync(_constant.USER_SPECICAL_INFO)||{},r=a.openid,e.next=5,_api2.default.addBrowser({query:{goodsId:t.goodsId,openId:r}});case 5:o=e.sent;case 6:case"end":return e.stop()}},e,this)}));return e}()},{key:"getGoodsEvaluate",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this,e.next=3,_api2.default.getGoodsEvaluate({query:{goodsId:t.goodsId,priceId:t.priceId}});case 3:a=e.sent,0==a.data.code?(t.commentList=a.data.commentList,t.commentCount=a.data.commentCount):a.data.msg?_tip2.default.error(a.data.msg):_tip2.default.error("获取商品评价信息失败"),t.$apply();case 6:case"end":return e.stop()}},e,this)}));return e}()},{key:"doTakeCart",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,a,r,o,i=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this,a=_wepy2.default.getStorageSync(_constant.USER_SPECICAL_INFO)||{},r=a.openid,e.next=5,_api2.default.addCart({query:{openId:r,goodsId:t.goodsId,goodsSkuId:this.detail.goodsSkuValIds,purchaseType:this.purchasetype,num:this.orderNum,priceId:this.detail.priceId}});case 5:o=e.sent,0==o.data.code?(this.winHeight="100%",this.animation.height(0).step(),this.setData({animationData:this.animation.export()}),setTimeout(function(){i.hidden=!0,i.$apply()},100),_tip2.default.success("成功加入购物车")):o.data.msg?_tip2.default.error(o.data.msg):_tip2.default.error("无法加入购物车");case 7:case"end":return e.stop()}},e,this)}));return e}()},{key:"doTakeOrder",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,a,r,o,i,n=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this,a=_wepy2.default.getStorageSync(_constant.USER_SPECICAL_INFO)||{},r=a.openid,e.next=5,_api2.default.addCart({query:{openId:r,goodsId:t.goodsId,goodsSkuId:this.detail.goodsSkuValIds,purchaseType:this.purchasetype,num:this.orderNum,priceId:this.detail.priceId}});case 5:return o=e.sent,e.next=8,_api2.default.cartCheck({query:{openId:r,goodsId:t.goodsId,priceId:this.detail.priceId}});case 8:i=e.sent,0==o.data.code?(this.winHeight="100%",this.animation.height(0).step(),this.setData({animationData:this.animation.export()}),setTimeout(function(){n.hidden=!0,n.$apply()},100),_wepy2.default.navigateTo({url:"/pages/comfire_order?goodsId="+t.goodsId+"&purchasetype="+t.purchasetype})):o.data.msg?_tip2.default.error(o.data.msg):_tip2.default.error("无法立刻购买");case 10:case"end":return e.stop()}},e,this)}));return e}()},{key:"showConfirmData",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:this.animation.height("783rpx").step(),this.setData({animationData:this.animation.export()}),setTimeout(function(){t.hidden=!1;var e=_wepy2.default.getStorageSync(_constant.SYSTEM_INFO);t.winHeight=e.windowHeight,t.$apply()},100);case 3:case"end":return e.stop()}},e,this)}));return e}()},{key:"goodsIsFavorite",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,a,r,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this,a=_wepy2.default.getStorageSync(_constant.USER_SPECICAL_INFO)||{},r=a.openid,e.next=5,_api2.default.goodsIsFavorite({query:{openId:r,goodsId:t.goodsId}});case 5:o=e.sent,0==o.data.code?1==o.data.isFavorite?(this.isFavorite=!0,console.log(this.isFavorite)):this.isFavorite=!1:(console.log("查看商品收藏失败"),o.data.msg?_tip2.default.error(o.data.msg):_tip2.default.error("查看商品收藏失败")),t.$apply();case 8:case"end":return e.stop()}},e,this)}));return e}()},{key:"goodsFavorite",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,a,r,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this,a=_wepy2.default.getStorageSync(_constant.USER_SPECICAL_INFO)||{},r=a.openid,e.next=5,_api2.default.goodsFavorite({query:{openId:r,goodsId:t.goodsId}});case 5:o=e.sent,0==o.data.code?(console.log("===========商品收藏成功========="),this.isFavorite=!0,_tip2.default.toast("收藏成功")):(console.log(o.data),_tip2.default.error("收藏失败")),t.$apply();case 8:case"end":return e.stop()}},e,this)}));return e}()},{key:"goodsUnFavorite",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,a,r,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this,a=_wepy2.default.getStorageSync(_constant.USER_SPECICAL_INFO)||{},r=a.openid,e.next=5,_api2.default.goodsUnFavorite({query:{openId:r,goodsId:t.goodsId}});case 5:o=e.sent,0==o.data.code?(console.log("===========商品取消收藏成功========="),_tip2.default.toast("取消收藏成功"),this.isFavorite=!1):(console.log(o.data),_tip2.default.error("取消收藏失败")),t.$apply();case 8:case"end":return e.stop()}},e,this)}));return e}()}]),t}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(goodsDetail,"pages/goods_detail"));